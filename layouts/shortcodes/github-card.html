{{ $repo := .Get 0 }}
{{ $uniqueId := printf "github-card-%s-%d" ($repo | replace "/" "-" | replace "." "-") now.UnixNano }}
<div class="github-card" id="{{ $uniqueId }}">
  <a class="github-card-link" href="https://github.com/{{ $repo }}" target="_blank" rel="noopener noreferrer">
    <!-- Header：左侧显示头像和仓库名称（下方带描述），右侧显示 GitHub Badge -->
    <div class="github-card-header">
      <div class="header-left">
        <div class="github-avatar"></div>
        <div class="repo-info">
          <div class="repo-name">{{ $repo }}</div>
          <div class="repo-description">Loading...</div>
        </div>
      </div>
      <div class="header-right">
        <svg class="github-badge" viewBox="0 0 16 16" version="1.1" aria-hidden="true"><path fill="currentColor" d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"></path></svg>
      </div>
    </div>
    <!-- Footer：显示主要语言、Star 和 Fork 数量 -->
    <div class="github-card-footer">
      <div class="footer-item">
        <span class="language-dot"></span>
        <span class="language"></span>
      </div>
      <div class="footer-item">
        <svg class="octicon" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
          <path fill-rule="evenodd" d="M8 12.5l-3.76 1.98a.75.75 0 01-1.09-.79l.72-4.19L.82 6.37a.75.75 0 01.42-1.28l4.21-.61L7.33.67a.75.75 0 011.34 0l1.88 3.81 4.21.61a.75.75 0 01.42 1.28l-3.05 2.97.72 4.19a.75.75 0 01-1.09.79L8 12.5zM8 11.06l3.76 1.98-.72-4.19 3.05-2.97-4.21-.61L8 1.94 6.24 5.27l-4.21.61 3.05 2.97-.72 4.19L8 11.06z"></path>
        </svg>
        <span class="stars"></span>
      </div>
      <div class="footer-item">
        <svg class="octicon" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true">
          <path fill-rule="evenodd" d="M5 3.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm0 2.122a2.25 2.25 0 10-1.5 0v.878A2.25 2.25 0 005.75 8.5h1.5v2.128a2.251 2.251 0 101.5 0V8.5h1.5a2.25 2.25 0 002.25-2.25v-.878a2.25 2.25 0 10-1.5 0v.878a.75.75 0 01-.75.75h-4.5A.75.75 0 015 6.25v-.878zm3.75 7.378a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm3-8.75a.75.75 0 100-1.5.75.75 0 000 1.5z"></path>
        </svg>
        <span class="forks"></span>
      </div>
    </div>
  </a>
</div>

<!-- CSS 样式 -->
<style>
  /* 整体卡片样式 */
  .github-card {
    width: 100%;
    margin: 12px 0;
    border-radius: 16px;
    background: #f8f9fa;
    border: 1px solid rgba(0, 0, 0, 0.03);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.03);
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
    position: relative;
  }
  .github-card-link {
    display: block;
    text-decoration: none;
    color: inherit;
  }
  /* Header 部分 */
  .github-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 1.2em;
  }
  .header-left {
    display: flex;
    align-items: center;
    gap: 0.8em;
  }
  .github-avatar {
    width: 36px;
    height: 36px;
    border-radius: 4px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iI2NjYyIgZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyczQuNDggMTAgMTAgMTAgMTAtNC40OCAxMC0xMFMxNy41MiAyIDEyIDJ6bTAgM2MyLjY3IDAgOC0xLjMzIDgtM3Y5LjE2Yy0yLjUgMS40NC00Ljc0IDEuODQtOCAxLjg0cy01LjUtLjQtOC0xLjg0VjJjMCAxLjY3IDUuMzMgMyA4IDN6Ii8+PC9zdmc+');
  }
  .repo-info {
    display: flex;
    flex-direction: column;
    gap: 0.4em;
  }
  .repo-name {
    font-size: 1.1em;
    font-weight: 600;
    color: #0969da;
    letter-spacing: -0.01em;
  }
  .repo-description {
    font-size: 0.9em;
    color: #57606a;
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .header-right {
    margin-left: auto;
  }
  .github-badge {
    width: 24px;
    height: 24px;
    color: #57606a;
  }
  /* Footer 部分 */
  .github-card-footer {
    display: flex;
    justify-content: flex-start;
    gap: 1.5em;
    padding: 0.8em 1.2em;
    font-size: 0.85em;
    color: #57606a;
  }
  .footer-item {
    display: flex;
    align-items: center;
    gap: 0.5em;
  }
  .footer-item .octicon {
    fill: currentColor;
  }
  .language-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    background-color: var(--language-color, #ccc);
  }
  /* 响应式设置 */
  @media (max-width: 480px) {
    .github-card {
      margin: 1em 0;
      width: 100%;
      border-radius: 10px;
    }
    .github-card-header {
      padding: 1em;
    }
    .header-left {
      gap: 0.6em;
      align-items: flex-start;
    }
    .github-avatar {
      min-width: 32px;
      width: 32px;
      height: 32px;
      margin-top: 0.2em;
    }
    .repo-info {
      gap: 0.3em;
    }
    .repo-name {
      font-size: 1em;
      line-height: 1.3;
    }
    .repo-description {
      font-size: 0.85em;
      line-height: 1.4;
    }
    .github-card-footer {
      padding: 0.8em 1em;
      gap: 1.2em;
    }
  }
  /* 深色模式适配 */
  .dark .github-card {
    background: #2a2b2e;
    border: 1px solid rgba(255, 255, 255, 0.04);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
  }
  .dark .repo-name {
    color: #58a6ff;
  }
  .dark .repo-description {
    color: #d4d4d4;
  }
  .dark .github-card-footer {
    color: #d4d4d4;
  }
  .dark .github-badge {
    color: #d4d4d4;
  }
</style>

<!-- JS：动态加载 GitHub 仓库信息 -->
<script>
  (async function() {
    const repo = "{{ $repo }}";
    const cardId = "{{ $uniqueId }}";
    
    // 全局队列管理，避免同时请求过多API
    if (!window.githubCardQueue) {
      window.githubCardQueue = [];
      window.githubCardProcessing = false;
    }
    
    const processQueue = async () => {
      if (window.githubCardProcessing || window.githubCardQueue.length === 0) return;
      
      window.githubCardProcessing = true;
      const task = window.githubCardQueue.shift();
      
      try {
        await task();
        // 添加延迟避免API限制
        await new Promise(resolve => setTimeout(resolve, 200));
      } catch (e) {
        console.error('GitHub card task failed:', e);
      }
      
      window.githubCardProcessing = false;
      // 处理下一个任务
      if (window.githubCardQueue.length > 0) {
        setTimeout(processQueue, 100);
      }
    };
    
    const loadGitHubInfo = async function(repo, elementId, retryCount = 0) {
      const cardEl = document.getElementById(elementId);
      if (!cardEl) return;
      
      try {
        // 添加超时控制
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10秒超时
        
        const response = await fetch(`https://api.github.com/repos/${repo}`, {
          signal: controller.signal,
          headers: {
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        // 更新头像
        const avatarEl = cardEl.querySelector('.github-avatar');
        if (avatarEl && data.owner.avatar_url) {
          avatarEl.style.backgroundImage = `url(${data.owner.avatar_url})`;
        }
        
        // 更新仓库描述
        const descEl = cardEl.querySelector('.repo-description');
        if (descEl) {
          descEl.textContent = data.description || "No description provided.";
        }
        
        // 更新主要语言、Star 和 Fork 数量
        const langEl = cardEl.querySelector('.language');
        const langDotEl = cardEl.querySelector('.language-dot');
        if (langEl && langDotEl) {
          langEl.textContent = data.language || "N/A";
          if (data.language) {
            const colors = {
              "JavaScript": "#f1e05a",
              "Python": "#3572A5",
              "Java": "#b07219",
              "TypeScript": "#2b7489",
              "C++": "#f34b7d",
              "Ruby": "#701516",
              "Go": "#00ADD8",
              "Rust": "#dea584",
              "PHP": "#4F5D95",
              "HTML": "#e34c26",
              "CSS": "#563d7c",
              "Vue": "#41b883",
              "Shell": "#89e051"
            };
            langDotEl.style.setProperty('--language-color', colors[data.language] || '#ccc');
          }
        }
        
        const starsEl = cardEl.querySelector('.stars');
        if (starsEl) starsEl.textContent = data.stargazers_count;
        
        const forksEl = cardEl.querySelector('.forks');
        if (forksEl) forksEl.textContent = data.forks_count;
        
      } catch (e) {
        console.error(`Error fetching GitHub repo data for ${repo}:`, e);
        
        // 重试机制：最多重试2次，每次延迟递增
        if (retryCount < 2) {
          const delay = (retryCount + 1) * 2000; // 2秒、4秒延迟
          console.log(`Retrying ${repo} in ${delay}ms (attempt ${retryCount + 1})`);
          setTimeout(() => {
            loadGitHubInfo(repo, elementId, retryCount + 1);
          }, delay);
          return;
        }
        
        // 显示错误状态
        const descEl = cardEl.querySelector('.repo-description');
        if (descEl) {
          if (e.name === 'AbortError') {
            descEl.textContent = "请求超时，请刷新页面重试";
          } else if (e.message.includes('403')) {
            descEl.textContent = "API请求限制，请稍后再试";
          } else if (e.message.includes('404')) {
            descEl.textContent = "仓库不存在或已私有";
          } else {
            descEl.textContent = "加载失败，请检查网络连接";
          }
          descEl.style.color = '#d73a49';
        }
      }
    };
    
    // 将加载任务添加到队列
    const executeLoad = () => {
      window.githubCardQueue.push(() => loadGitHubInfo(repo, cardId));
      processQueue();
    };
    
    // 立即执行或在DOM加载完成后执行
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', executeLoad);
    } else {
      executeLoad();
    }
  })();
</script>
